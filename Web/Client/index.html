<!DOCTYPE html>
<html>
   <head>
      <title>Klampt Three.js app</title>
      <meta charset="UTF-8">

      <script src="w2ui/libs/jquery/jquery-2.1.4.min.js"></script>

      <link rel="stylesheet" type="text/css" href="w2ui/dist/w2ui.min.css" />
      <script type="text/javascript" src="w2ui/dist/w2ui.min.js"></script>

      <script src="three.js/build/three.min.js"></script> 
      <script src="three.js/examples/js/controls/TrackballControls.js"></script> 

      <script src="stats.js/build/stats.min.js"></script>

      <script src="DaveWebsocket.js"></script> 

      <script src="KlamptClient.js"></script> 
          
      <!--
      <link rel="stylesheet" href="CodeMirror-master/lib/codemirror.css">
      <link rel="stylesheet" href="CodeMirror-master/addon/hint/show-hint.css">
         
      <script src="CodeMirror-master/lib/codemirror.js"></script>
      <script src="CodeMirror-master/addon/hint/show-hint.js"></script>
      <script src="CodeMirror-master/mode/python/python.js"></script>
      -->
      
      <script src="ace-builds/src-noconflict/ace.js"></script>
      <script src="ace-builds/src-noconflict/ext-language_tools.js"></script>
   
   </head>
    
   <body style="margin: 0px;">
      <div id="myLayout" style="position: absolute; top: 0; right: 0; bottom: 0; left: 0;"></div>
   
            
      <script>
         //var stats = new Stats();
			//stats.showPanel( 0 );
			//document.body.appendChild( stats.dom );
   
         var network; 
         var editor;
         var visPanel;
         var localStorageAvailable=false;
         var localStorage;
         var newBoilerplate=true;
         
         function storageAvailable()
         {
            try {
               localStorage = window['localStorage'],
                  x = '__storage_test__';
               localStorage.setItem(x, x);
               localStorage.removeItem(x);
               console.log("looks like local storage is setup");

               return true;
            }
            catch(e) {
               console.log("looks like storage is not setup: " + e);
               return false;
            }
         }        
         
                                  
         function doCodeSubmit()
         {
            var textArea=document.getElementById("myTextarea");
            textArea.value="> ";
             
            if(localStorageAvailable)
            {
              localStorage.setItem('KlamptStartingCode_'+$('#boilerselctor').val(), editor.getValue());           
            }

            if(!KLAMPT.isConnected()) {
               var URL=$('#serverURL').val();
               KLAMPT.connect(URL,$('#boilerselctor').val(),function() { KLAMPT.setCode(editor.getValue()); newBoilerplate = false;},null);
            }
            else if(newBoilerplate) {
               //connected, but need new boilerplate.  Hence we need to disconnect and then reconnect. 
               KLAMPT.disconnect(doCodeSubmit);
               newBoilerplate = false;
            }
            else {
               //connected, same boilerplate, just changing code.
               KLAMPT.setCode(editor.getValue());
            }
         }

         function requestAdvance()
         {
            if(!KLAMPT.isConnected() || newBoilerplate)
            {
               doCodeSubmit();
            }
            KLAMPT.advance();
         }
         function requestFreeRun()
         {
            if(!KLAMPT.isConnected() || newBoilerplate)
            {
               doCodeSubmit();
            }
            KLAMPT.animate(true);
         }
         
         //the magic of AJAX
         //http://stackoverflow.com/questions/3567369/reading-server-side-file-with-javascript
         function loadFileToEditor(file_to_load)
         {
            
            console.log("Trying to load stub code "+file_to_load);
            $.ajax({
               url: file_to_load,
               async: true,   // asynchronous request? (synchronous requests are discouraged...)
               cache: false,   // with this, you can force the browser to not make cache of the retrieved data
               dataType: "text",  // jQuery will infer this, but you can set explicitly
               success: function( data, textStatus, jqXHR ) {
                  editor.getSession().setValue(data); 
               },
               error : function( jqXHR, textStatus, errorThrown ) {
                  console.log("Error loading stub code: "+textStatus)
                  editor.getSession().setValue(""); 
               }
            });
         }


         function serverChanged()
         {
            console.log("Server changed.");
            KLAMPT.disconnect();
         }

         function doRevertChanges()
         {
            if (confirm("Are you sure you want to discard ALL changes?") == true) {
              var boilerid=$('#boilerselctor').val();
              var file_to_load="Scenarios/code_"+boilerid+".py";
              loadFileToEditor(file_to_load);
              
              KLAMPT.animate(false);
            }
         }
   
         function boilerPlateChanged()
         {
            var boilerid=$('#boilerselctor').val();
            var file_to_load="Scenarios/code_"+boilerid+".py";
         
            if(localStorageAvailable) //lets see if we have worked on this previously
            {
               var example1Text=localStorage.getItem('KlamptStartingCode_'+boilerid);
               if(example1Text!=null)
               {               
                  editor.getSession().setValue(example1Text);
               }
               else
               {
                  loadFileToEditor(file_to_load);
               }
            }
            else
               loadFileToEditor(file_to_load);
            newBoilerplate = true;
            KLAMPT.animate(false);
         }   
         
         
     
         $( document ).ready(function() {
            console.log("page is ready, lets setup some stuff");
            console.log("first testing if local storage is available");
            localStorageAvailable=storageAvailable();
            console.log("  local storage test determined: " + localStorageAvailable);
 
            var pstyle = 'background-color: #F5F6F7; border: 1px solid #dfdfdf; padding: 5px;';
            $('#myLayout').w2layout({
               name: 'layout',
               panels: [
                  { type: 'top',  size: "5%", resizable: true, style: pstyle, content: '<button onclick="doCodeSubmit()">Reset</button><button onclick="requestAdvance()">Advance Frame</button><button onclick="requestFreeRun()">Run</button><button onclick="KLAMPT.animate(false)">Stop</button> <div style=" width:20px;display:inline-block;" />Klampt Server URL:<select id="serverURL" onchange="serverChanged()"/><div style=" width:20px;display:inline-block;" /><select id="boilerselctor" onchange="boilerPlateChanged()"></select><button onclick="doRevertChanges()">Revert to Skeleton Code</button> <span style="float:right"> <a href="http://motion.pratt.duke.edu/klampt/pyklampt_docs/namespaces.html" target="_blank">Klamp&#39;t Python API Docs</a> <a href="kviz_docs.html" target="_blank">kviz module docs</a> </span> '},
                  { type: 'main', style: pstyle, content: '<div id="canvas" style="width:100%; height:100%; margin:0; padding:0"></div>' },
                  { type: 'preview', size: "15%", resizable: true, style: pstyle, content: '<textarea readonly id="myTextarea" style="background-color: black;color:white;width:100%;height:100%">> </textarea></div></div>' },
                  { type: 'right', size: '50%', resizable: true, style: pstyle, content: 
                    '<div id="editor" style="width:100%; height:100%; margin:0; padding:0"></div>' },               ]
            });

            function add_server(val,text) {
		$('#serverURL').append($('<option>', {value:val}).text(text));
            }
            add_server("ws://rapid-165.vm.duke.edu:1234","rapid-165");
            add_server("ws://rapid-174.vm.duke.edu:1234","rapid-174");
            add_server("ws://rapid-175.vm.duke.edu:1234","rapid-175");
            add_server("ws://rapid-176.vm.duke.edu:1234","rapid-176");
            //set a random server
            var $options = $('#serverURL').find('option'),
               random = ~~(Math.random() * $options.length);
            $options.eq(random).prop('selected', true);

            function add_option(id,text) {
               $('#boilerselctor').append($('<option>', {value:id}).text(text));
            }
            add_option("lab3a","Lab 3a");
            add_option("lab3b","Lab 3b");
            add_option("lab3d","Lab 3d");
            add_option("test_sim","Test Simulation");
            add_option("sandbox","Simulation Sandbox");
            add_option("kinematic_sandbox","Kinematic Sandbox");

            //if(localStorageAvailable) {
            //   var url=localStorage.getItem('serverURL');
            //   if(url!=null) {
            //      $('#serverURL').val(url);
            //   }
            //}
            
          

            ace.require("ace/ext/language_tools"); //setup the text editor
            editor = ace.edit("editor");
      
            editor.setOptions({
               enableBasicAutocompletion: true,
               enableSnippets: false,
               enableLiveAutocompletion: false,
               showPrintMargin: false
            });
      
            editor.setTheme("ace/theme/eclipse"); 
            editor.getSession().setMode("ace/mode/python");
            
            boilerPlateChanged();
                       
            //var editor = CodeMirror( document.getElementById("editor"), { //use codemirror as text editor
            //value: "print 'hello world'\n",
            //mode:  "python",
            //lineNumbers: true,
            //autohint: true,
            //hint: true
            //});

            w2ui.layout.on('resize', function(event) { //make sure three.js canvas resizes when sub-window size changes
               event.onComplete = function () {
                  console.log("resize completed"); 
                  onWindowResize(event);
               }
            });
 
            visPanel=w2ui['layout'].get('main');   
     
            var container = document.getElementById("canvas");
            var textArea = document.getElementById("myTextarea");
            KLAMPT.init(container,textArea);
            onWindowResize();
         });
         
         function onWindowResize( event )
         {
            console.log("onWindowResize");
         
            //account for 5px padding on each side
            KLAMPT.windowResize(visPanel.width-11,visPanel.height-11);
         }       

      </script>
   </body>
</html>
